# 文档转换服务 - 系统架构

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          文档转换服务架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                             客户端层                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   Web 浏览器 │  │   curl 命令  │  │   Postman   │  │   其他客户端  │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API 网关层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    FastAPI 应用服务器                              │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   CORS 中间件 │  │   路由分发   │  │   错误处理   │  │   静态文件   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API 路由层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   /api/convert │  │/api/batch-convert│  │  /api/formats  │  │/api/status/{id}│      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           业务逻辑层                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    转换服务 (ConversionService)                    │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   文件验证   │  │   格式检查   │  │   转换调度   │  │   结果处理   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    验证服务 (ValidationService)                    │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   文件类型   │  │   文件大小   │  │   格式支持   │  │   安全检查   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           转换器层                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                LibreOffice 转换器                                 │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   Office 文档 │  │   格式转换   │  │   进程池管理 │  │   异步处理   │  │
│  │  │   (doc/docx) │  │   (xls/xlsx)│  │   (ppt/pptx)│  │   (odt/ods) │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   PDF 转换器                                      │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   PDF 解析   │  │   文本提取   │  │   图片提取   │  │   OCR 识别   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   图片转换器                                       │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   格式转换   │  │   尺寸调整   │  │   质量优化   │  │   批量处理   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           工具层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    文件工具 (FileUtils)                            │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   文件保存   │  │   文件清理   │  │   路径管理   │  │   大小检查   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    配置管理 (Config)                               │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  │   环境变量   │  │   格式配置   │  │   路径配置   │  │   选项配置   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           存储层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   temp/     │  │  outputs/   │  │   logs/     │  │   cache/     │      │
│  │  临时文件    │  │  输出文件    │  │   日志文件   │  │   缓存文件    │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           系统依赖层                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │ LibreOffice │  │  Tesseract  │  │   Poppler   │  │   Python    │      │
│  │   (文档处理) │  │   (OCR 识别) │  │  (PDF 工具)  │  │   (运行时)   │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 📁 项目结构详解

```
doc-conversion-service/
├── 📁 .ven/                          # Python 虚拟环境
├── 📁 app/                           # 主应用代码
│   ├── 📁 api/                       # API 层
│   │   ├── 📄 routes.py             # API 路由定义
│   │   ├── 📄 models.py             # 数据模型
│   │   └── 📄 __init__.py
│   ├── 📁 converters/                # 转换器层
│   │   ├── 📄 libreoffice_converter.py  # LibreOffice 转换器
│   │   ├── 📄 pdf_converter.py      # PDF 转换器
│   │   ├── 📄 image_converter.py    # 图片转换器
│   │   └── 📄 __init__.py
│   ├── 📁 services/                  # 业务逻辑层
│   │   ├── 📄 conversion.py         # 转换服务
│   │   ├── 📄 validation.py         # 验证服务
│   │   └── 📄 __init__.py
│   ├── 📁 utils/                     # 工具层
│   │   ├── 📄 file_utils.py         # 文件工具
│   │   └── 📄 __init__.py
│   ├── 📁 config/                    # 配置层
│   │   ├── 📄 settings.py           # 应用配置
│   │   └── 📄 __init__.py
│   └── 📄 main.py                   # 应用入口
├── 📁 tests/                         # 测试层
│   ├── 📄 test_main.py              # 主应用测试
│   ├── 📄 test_libreoffice_converter.py  # LibreOffice 测试
│   ├── 📄 conftest.py               # 测试配置
│   └── 📄 __init__.py
├── 📁 outputs/                       # 输出文件存储
├── 📁 temp/                          # 临时文件存储
├── 📁 logs/                          # 日志文件存储
├── 📄 requirements.txt               # Python 依赖
├── 📄 pyproject.toml                # 项目配置
├── 📄 Dockerfile                     # Docker 配置
├── 📄 docker-compose.yml            # Docker Compose
├── 📄 Makefile                      # 开发工具
├── 📄 test_api.sh                   # API 测试脚本
├── 📄 CURL_USAGE.md                 # curl 使用指南
├── 📄 performance_test.py           # 性能测试
└── 📄 README.md                     # 项目说明
```

## 🔄 数据流程图

```
用户请求 → API 网关 → 业务逻辑 → 转换器 → 系统工具 → 存储
    ↓         ↓         ↓         ↓         ↓         ↓
  客户端    FastAPI   服务层    转换层    工具层    文件系统
    ↓         ↓         ↓         ↓         ↓         ↓
  响应 ←  路由分发 ←  结果处理 ←  转换结果 ←  文件操作 ←  磁盘存储
```

## 🏛️ 分层架构详解

### 1. 客户端层 (Client Layer)
- **Web 浏览器**: 访问 Swagger UI 文档
- **curl 命令**: 命令行 API 调用
- **Postman**: API 测试工具
- **其他客户端**: 移动应用、桌面应用等

### 2. API 网关层 (API Gateway Layer)
- **FastAPI 框架**: 高性能异步 Web 框架
- **CORS 中间件**: 跨域资源共享
- **路由分发**: 请求路由到对应的处理器
- **错误处理**: 统一错误响应
- **静态文件**: 提供文档和输出文件访问

### 3. API 路由层 (API Routes Layer)
- **`/api/convert`**: 单个文件转换
- **`/api/batch-convert`**: 批量文件转换
- **`/api/formats`**: 获取支持的格式
- **`/api/status/{id}`**: 查询转换状态

### 4. 业务逻辑层 (Business Logic Layer)

#### 转换服务 (ConversionService)
```python
class ConversionService:
    def __init__(self):
        self.libreoffice_converter = LibreOfficeConverter()
        self.pdf_converter = PDFConverter()
        self.image_converter = ImageConverter()
    
    async def convert(self, input_path, target_format, options):
        # 1. 验证输入文件
        # 2. 选择转换器
        # 3. 执行转换
        # 4. 处理结果
```

#### 验证服务 (ValidationService)
```python
class ValidationService:
    def validate_file_type(self, file):
        # 检查文件类型
        
    def validate_file_size(self, file):
        # 检查文件大小
        
    def validate_conversion_support(self, input_format, output_format):
        # 检查转换支持
```

### 5. 转换器层 (Converter Layer)

#### LibreOffice 转换器
- **功能**: 处理 Office 文档转换
- **支持格式**: doc, docx, xls, xlsx, ppt, pptx, odt, ods, odp
- **特点**: 使用进程池管理，异步处理
- **性能**: 并发转换，超时控制

#### PDF 转换器
- **功能**: 处理 PDF 相关转换
- **支持格式**: PDF 转 Office 文档、图片
- **特点**: OCR 识别，文本提取
- **性能**: 多页处理，图片提取

#### 图片转换器
- **功能**: 处理图片格式转换
- **支持格式**: jpg, png, gif, bmp, tiff, webp
- **特点**: 尺寸调整，质量优化
- **性能**: 批量处理，格式转换

### 6. 工具层 (Utility Layer)

#### 文件工具 (FileUtils)
```python
class FileUtils:
    @staticmethod
    def save_uploaded_file(file, path):
        # 保存上传文件
        
    @staticmethod
    def cleanup_temp_file(path):
        # 清理临时文件
        
    @staticmethod
    def get_file_size(path):
        # 获取文件大小
```

#### 配置管理 (Config)
```python
# 支持的转换格式
SUPPORTED_CONVERSIONS = {
    'doc': ['pdf', 'docx', 'odt', 'rtf', 'html', 'txt'],
    'docx': ['pdf', 'doc', 'odt', 'rtf', 'html', 'txt'],
    # ... 更多格式
}

# 文件大小限制
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
```

### 7. 存储层 (Storage Layer)
- **temp/**: 临时文件存储
- **outputs/**: 转换结果输出
- **logs/**: 应用日志文件
- **cache/**: 缓存文件

### 8. 系统依赖层 (System Dependencies)
- **LibreOffice**: 文档处理引擎
- **Tesseract**: OCR 文字识别
- **Poppler**: PDF 处理工具
- **Python**: 运行时环境

## 🔄 请求处理流程

### 单个文件转换流程
```
1. 客户端发送 POST 请求到 /api/convert
2. FastAPI 接收请求并路由到转换处理器
3. ValidationService 验证文件类型和大小
4. ConversionService 选择合适的转换器
5. LibreOfficeConverter 执行文档转换
6. FileUtils 保存转换结果
7. 返回转换结果给客户端
```

### 批量转换流程
```
1. 客户端发送 POST 请求到 /api/batch-convert
2. 解析多个文件和转换选项
3. 为每个文件创建异步转换任务
4. 并发执行所有转换任务
5. 收集所有转换结果
6. 返回批量转换结果
```

## 🚀 性能优化策略

### 1. 异步处理
- 使用 `asyncio` 进行异步 I/O
- 非阻塞的文件操作
- 并发处理多个请求

### 2. 进程池管理
```python
class LibreOfficeConverter:
    def __init__(self, max_workers=3):
        self.executor = ProcessPoolExecutor(max_workers=max_workers)
```

### 3. 缓存机制
- 转换结果缓存
- 格式支持缓存
- 配置信息缓存

### 4. 资源控制
- 文件大小限制 (100MB)
- 转换超时控制 (5分钟)
- 并发数量限制 (3个进程)

## 🔧 部署架构

### 开发环境
```
┌─────────────────┐
│   Python 3.8+   │
├─────────────────┤
│   FastAPI       │
├─────────────────┤
│   LibreOffice   │
├─────────────────┤
│   Tesseract     │
└─────────────────┘
```

### 生产环境 (Docker)
```
┌─────────────────────────────────────┐
│           Nginx 反向代理            │
├─────────────────────────────────────┤
│         FastAPI 应用服务器          │
├─────────────────────────────────────┤
│         LibreOffice 转换器          │
├─────────────────────────────────────┤
│         Redis 缓存/队列             │
├─────────────────────────────────────┤
│         Celery 任务队列             │
└─────────────────────────────────────┘
```

## 📊 监控和日志

### 日志级别
- **INFO**: 正常操作日志
- **WARNING**: 警告信息
- **ERROR**: 错误信息
- **DEBUG**: 调试信息

### 监控指标
- 转换成功率
- 平均转换时间
- 并发请求数
- 系统资源使用

这个架构设计遵循了分层架构原则，每一层都有明确的职责，便于维护和扩展。通过异步处理和进程池管理，确保了高性能的文档转换服务。 