# 文档转换服务 - 简化架构说明

## 🎯 核心概念

这是一个**分层架构**的文档转换服务，每一层都有明确的职责：

```
用户 → API → 业务逻辑 → 转换器 → 文件系统
```

## 🏗️ 8层架构详解

### 第1层：客户端层
**作用**: 用户与服务的交互界面
- **Web浏览器**: 访问 http://localhost:8000/docs 查看API文档
- **curl命令**: 命令行调用API
- **Postman**: API测试工具
- **其他客户端**: 移动应用、桌面应用等

### 第2层：API网关层
**作用**: 接收和处理HTTP请求
- **FastAPI框架**: 高性能异步Web框架
- **CORS中间件**: 允许跨域请求
- **路由分发**: 将请求发送到正确的处理器
- **错误处理**: 统一处理错误并返回友好信息

### 第3层：API路由层
**作用**: 定义具体的API端点
- **`/api/convert`**: 单个文件转换
- **`/api/batch-convert`**: 批量文件转换
- **`/api/formats`**: 获取支持的格式
- **`/api/status/{id}`**: 查询转换状态

### 第4层：业务逻辑层
**作用**: 处理业务规则和逻辑

#### 转换服务 (ConversionService)
```python
# 主要职责：
1. 验证输入文件
2. 选择合适的转换器
3. 执行转换
4. 处理结果
```

#### 验证服务 (ValidationService)
```python
# 主要职责：
1. 检查文件类型
2. 验证文件大小 (最大100MB)
3. 确认格式支持
4. 安全检查
```

### 第5层：转换器层
**作用**: 执行具体的文档转换

#### LibreOffice转换器
- **处理**: Office文档 (doc, docx, xls, xlsx, ppt, pptx)
- **特点**: 使用进程池，支持并发转换
- **性能**: 3个并发进程，5分钟超时

#### PDF转换器
- **处理**: PDF文件解析和转换
- **功能**: 文本提取、图片提取、OCR识别
- **工具**: PyMuPDF, pdfplumber, Tesseract

#### 图片转换器
- **处理**: 图片格式转换
- **支持**: jpg, png, gif, bmp, tiff, webp
- **功能**: 尺寸调整、质量优化

### 第6层：工具层
**作用**: 提供通用工具和配置

#### 文件工具 (FileUtils)
```python
# 主要功能：
- 保存上传文件
- 清理临时文件
- 管理文件路径
- 检查文件大小
```

#### 配置管理 (Config)
```python
# 主要配置：
- 支持的转换格式
- 文件大小限制
- 路径配置
- 环境变量
```

### 第7层：存储层
**作用**: 文件存储和管理
- **temp/**: 临时文件存储
- **outputs/**: 转换结果输出
- **logs/**: 应用日志文件
- **cache/**: 缓存文件

### 第8层：系统依赖层
**作用**: 底层系统工具
- **LibreOffice**: 文档处理引擎
- **Tesseract**: OCR文字识别
- **Poppler**: PDF处理工具
- **Python**: 运行时环境

## 🔄 请求处理流程

### 单个文件转换流程
```
1. 用户上传文件 → POST /api/convert
2. FastAPI接收请求
3. 验证文件类型和大小
4. 选择合适的转换器
5. 执行文档转换
6. 保存转换结果
7. 返回下载链接
```

### 批量转换流程
```
1. 用户上传多个文件 → POST /api/batch-convert
2. 解析所有文件和选项
3. 为每个文件创建转换任务
4. 并发执行所有转换
5. 收集所有结果
6. 返回批量结果
```

## 🚀 性能优化

### 异步处理
- 使用`asyncio`进行非阻塞I/O
- 支持并发处理多个请求

### 进程池管理
```python
# LibreOffice转换器使用进程池
self.executor = ProcessPoolExecutor(max_workers=3)
```

### 资源控制
- 文件大小限制: 100MB
- 转换超时: 5分钟
- 并发进程数: 3个

## 📊 支持的转换格式

### 输入格式
- **Office文档**: doc, docx, xls, xlsx, ppt, pptx, odt, ods, odp
- **PDF**: pdf
- **图片**: jpg, png, gif, bmp, tiff, webp
- **其他**: rtf, html, txt

### 输出格式
- **PDF**: 所有格式都可以转换为PDF
- **Office**: docx, xlsx, pptx, odt, ods, odp
- **图片**: jpg, png, gif, bmp, tiff
- **其他**: rtf, html, txt

## 🎯 架构优势

### 1. 分层清晰
- 每层职责明确
- 便于维护和扩展
- 降低耦合度

### 2. 高性能
- 异步处理
- 并发转换
- 进程池管理

### 3. 可扩展
- 易于添加新的转换器
- 支持新的文件格式
- 模块化设计

### 4. 可靠性
- 错误处理机制
- 超时控制
- 资源限制

## 🔧 部署方式

### 开发环境
```bash
# 启动服务
source .ven/bin/activate
python -m app.main
```

### 生产环境 (Docker)
```bash
# 使用Docker Compose
docker-compose up -d
```

这个架构设计遵循了**单一职责原则**和**依赖倒置原则**，每一层都专注于自己的职责，通过接口进行交互，使得系统更加稳定和可维护。 